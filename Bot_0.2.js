class Y{plugins=[];messageQueue=[];maxQueueSize=1000;listeners=[];timeoutUpdateMillis=1e4;timers={};cancelTrace(f){if(this.messageManager.has(f)){const{resolve:N,timer:R}=this.messageManager.get(f);clearTimeout(R),N({code:499,msg:"Trace canceled"}),this.messageManager.delete(f)}}config;slotLists;deviceLists;webAppUserInfo=[];chatGroupAndUsers;context=null;configs={};setContextConfig(f,N){return this.configs[f]=N,this}getContextConfig(f){return this.configs[f]}removeContextConfig(f){return delete this.configs[f],this}constructor(f,N="https://us.jeejio.com/im"){this.config={apiUrl:N,token:f},this.startQueueProcessor()}use(f){if(this.plugins.includes(f))return this;return f(this),this.plugins.push(f),this}on(f){return this.listeners.push(f),this}emit(f,N){if(this.messageQueue.length>=this.maxQueueSize)this.messageQueue.shift();if(!N)return;this.messageQueue.push(N)}startQueueProcessor(){setInterval(async()=>{while(this.messageQueue.length>0){const f=this.messageQueue.shift();if(f){const N=f?.traceId;if(N)this.triggerTraceCallback(N,f);const R=async($)=>{if($>=this.listeners.length)return;const z=this.listeners[$];try{await z(f,()=>R($+1))}catch(E){console.error(`\u5904\u7406 ${f.type} \u6D88\u606F\u5931\u8D25\uFF1A`,E)}};await R(0)}}},100)}start(f={im:!0,mqtt:!0}){if(f.im)this.stopIm(),this.timers.user=setTimeout(()=>{},0),this.pollImMessages();if(f.mqtt)this.stopMqtt(),this.timers.device=setTimeout(()=>{},0),this.pollMqttMessages();return this}async pollImMessages(){try{const f=new AbortController,N=setTimeout(()=>f.abort(),180000),R=await fetch(`${this.config.apiUrl}/bot/messages/updates?token=${this.config.token}&timeoutMillis=${this.timeoutUpdateMillis}`,{method:"GET",headers:{"Content-Type":"application/json"},signal:f.signal});clearTimeout(N);const $=await R.json();let z={type:"user",data:{ctx:$?.result[0]}},E=$?.result[0],H;if(E?.type==="im")H={message_id:E?.from,from:E?.from,me:{...E?.extend?.me},chat:{...E?.extend?.chat},message:{...E?.params},timestamp:E?.timestamp,web_app_data:""},this.emit("user",H);else if(E?.method==="event"&&E?.type==="rpc")H={message_id:E?.from,from:{...E?.extend?.from},chat:{...E?.extend?.chat},timestamp:E?.timestamp,callback:{value:E?.params?.event?.data}},this.emit("user",H)}catch(f){this.emit("user",{error:f.message}),await new Promise((N)=>setTimeout(N,3000))}if(this.timers.user)this.pollImMessages()}stopIm(){if(this.timers.user)clearTimeout(this.timers.user);this.timers.user=void 0}stopMqtt(){if(this.timers.device)clearTimeout(this.timers.device);this.timers.device=void 0}async pollMqttMessages(){try{const f=new AbortController,N=setTimeout(()=>f.abort(),180000),R=await fetch(`${this.config.apiUrl}/bot/messages/device/updates?token=${this.config.token}&timeoutMillis=${this.timeoutUpdateMillis}`,{method:"GET",headers:{"Content-Type":"application/json"},signal:f.signal});clearTimeout(N);const $=await R.json();let z,E=$?.result[0];if($.traceId=E?.extend?.traceId,E?.type==="rpc"){let H;if(E?.method==="onReceive")H=Object.keys(E?.params).map((J)=>({method:J,params:{value:E?.params[J].value}})),z={traceId:E?.extend?.traceId,message_id:E?.from,from:{...E?.extend?.from},timestamp:E?.timestamp,rpc:{notify:[...H]}},this.emit("device",z);else this.emit("device",$)}else if(E?.method==="event")z={traceId:E?.extend?.traceId,message_id:E?.from,from:{...E?.extend?.from},chat:{...E?.extend?.chat},timestamp:E?.timestamp,callback:{value:E?.params?.event?.data}},this.emit("device",z);else this.emit("device",$)}catch(f){this.emit("device",{error:f.message}),await new Promise((N)=>setTimeout(N,5000))}if(this.timers.device)this.pollMqttMessages()}async sendBindDeviceMessage(f,N,R=38,$,z,E){const H=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:$,mentionOnly:E||!1,token:this.config.token,type:R,to:{id:N},chat:{...f},payload:{actionButtonTitle:z||"Link Devices"}})}).then((J)=>J.json()).then((J)=>{})}async sendTextMessage(f,N,R){const $=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:N,token:this.config.token,type:0,to:{id:f?.from?.id},chat:{...f?.chat}})}).then((z)=>z.json()).then((z)=>{})}async getBotDetails(f){return await fetch(`${this.config.apiUrl}/bot/detail?token=${this.config.token}&contactId=${f}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then((R)=>R.json()).then((R)=>{return R})}async sendCupTalkMessage(f,N,R,$,z){const E=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:$,mentionOnly:!0,token:this.config.token,type:R,to:{id:N},chat:{...f}})}).then((H)=>H.json()).then((H)=>{})}async sendFileMessage(f,N,R=4,$){const z=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:R===4?JSON.stringify({content:"\u6587\u4EF6",token:this.config.token,type:R,to:{id:N},payload:{file:{name:$?.filename,url:$?.url,mimeType:$?.mimeType,size:$?.size}}}):JSON.stringify({token:this.config.token,content:"\u56FE\u7247",type:R,to:{id:N},payload:{thumb:{name:$?.filename,url:$?.url,size:$?.size},compressed:{name:$?.filename,url:$?.url,size:$?.size},original:{name:$?.filename,url:$?.url,size:$?.size},width:$?.width,height:$?.height}})}).then((E)=>E.json()).then((E)=>{})}async sendTempMessageIM(f,N,R){const $=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:f?.text,token:this.config.token,type:37,to:{id:R},chat:{...N},payload:{at:[],type:"InlineKeyboard",content:{rows:[{buttons:[{title:f?.title,type:1,value:f?.url}]}]}}})}).then((z)=>z.json()).then((z)=>{})}async sendMessageResponse(f,N,R,$=[]){const z=await fetch(`${this.config.apiUrl}/bot/msg/response`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.config.token,id:R,payload:{inlineQueryResult:[...$]}})}).then((E)=>E.json()).then((E)=>{})}async syncSlotSave(f){const N=await fetch(`${this.config.apiUrl}/bot/slot/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.config.token,slotList:f})}).then((R)=>R.json()).then((R)=>{}).catch((R)=>{return R})}async setMyCommands(f,N=!1){return await(await fetch(`${this.config.apiUrl}/bot/command/save`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.config.token,inlineModeEnabled:N,commandList:f})})).json()}async sendPrivateInlineKeyMDMessage(f,N,R,$){const z=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:R,token:this.config.token,type:37,to:{id:N},chat:{...f},payload:{type:"InlineKeyboard",content:{rows:[{buttons:[{title:$,type:2,value:"maopao://select-group-add-bot"}]}]}}})}).then((E)=>E.json()).then((E)=>{})}async sendInlineKeyMDMessage(f,N,R,$){const z=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:R,token:this.config.token,type:37,to:{id:N},chat:{...f}})}).then((E)=>E.json()).then((E)=>{})}async sendMessageMD(f,N,R){const $=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:N,token:this.config.token,type:37,to:{id:f?.from?.id},chat:{...f?.chat}})}).then((z)=>z.json()).then((z)=>{})}async sendInlineKeyMDMessageOtherText(f,N,R,$="",z){const E=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:R+$,token:this.config.token,type:37,to:{id:N},chat:{...f}})}).then((H)=>H.json()).then((H)=>{})}transformButtons(f){if(!Array.isArray(f))throw new Error("\u8F93\u5165\u5FC5\u987B\u662F\u4E00\u4E2A\u6570\u7EC4");return{rows:f.map((R)=>({buttons:R}))}}async sendInlineMessage(f,N,R,$,z,E){let H=this.transformButtons($);const J=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:R,token:this.config.token,type:37,to:{id:N},chat:{...f},payload:{type:"InlineKeyboard",content:{...H}}})}).then((Q)=>Q.json()).then((Q)=>{})}async sendMessage(f,N,R){const $=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:N?.name?JSON.stringify({content:N?.name,token:this.config.token,type:37,to:{id:R},chat:{...f},payload:{type:"InlineKeyboard",content:{rows:N?.rows}}}):JSON.stringify({content:N,token:this.config.token,type:0,to:{id:R},chat:{...f}})}).then((z)=>z.json()).then((z)=>{})}async sendButtonStyleMessage(f,N,R,$,z){let E=this.transformButtons(R);const H=await fetch(`${this.config.apiUrl}/bot/msg`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:N,token:this.config.token,type:37,to:{id:f?.from?.id},chat:{...f?.chat},payload:{type:"InlineKeyboard",content:{...E}}})}).then((J)=>J.json()).then((J)=>{})}stopAll(){return Object.values(this.timers).forEach((f)=>{if(f)clearTimeout(f)}),this}clearQueue(){return this.messageQueue=[],this}bindDevices(...f){let N=f;N.forEach(($,z)=>{if($.token=this.config.token,$.bindingIndex=z+1,$.slot=z+1,$&&typeof $.setBot==="function")$.setBot(this)});let R=N.map(($,z)=>{return{slot:z+1,name:$?.deviceAliasName,talId:$?.talId}});this.slotLists=R,this.deviceLists=R,this.syncSlotSave(R)}async getDeviceFirmware(f){return await fetch(`${this.config.apiUrl}/bot/device/firmware?token=${this.config.token}&deviceId=${f}`,{method:"GET",headers:{"Content-Type":"application/json"}}).then((R)=>R.json()).then((R)=>{return R})}async updateTargetFirmware(f,N,R,$,z){return await fetch(`${this.config.apiUrl}/bot/device/firmware/upgrade`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:this.config.token,fromId:$,chatId:R,slot:N,firmwareId:z})}).then((H)=>H.json()).then((H)=>{return H})}async sendWebAppMessage(f,N,R){const $=await fetch(`${this.config.apiUrl}/bot/msg/web`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:R?.text||"sendWebApp",token:this.config.token,type:0,to:{id:N},chat:{...f},payload:{success:!0,id:R?.id,type:R?.type||"WebApp",content:{...R}}})}).then((z)=>z.json()).then((z)=>{}).catch((z)=>{})}messageManager=new Map;setDevMessage(f,N,R){let $,z={};if(f?.chat?.type==="private")z=f.chat,$=f?.from?.id;if(f?.chat?.type==="group")z=f.chat,$=f?.from?.id;return new Promise((E,H)=>{const J=`trace_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,Q=this.waitForTrace(J,20000);let S=N?.bindingIndex?N?.bindingIndex:1;fetch(this.config.apiUrl+"/bot/device/msg",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({traceId:J,token:this.config.token,msg:{value:{method:R?.method,params:{...R?.params}}},slot:S,chat:{...f}})}).then((V)=>V.json()).then(async(V)=>{if(V.code!==201){this.cancelTrace(J),H(V);return}if(Q)try{try{let X={code:200,...await Q};E({...X})}catch(W){}}catch(W){console.warn("waitForTrace error:",W),E(V)}else E(V)}).catch((V)=>{this.cancelTrace(J),H(V)})})}triggerTraceCallback(f,N){if(this.messageManager.has(f)){const{resolve:R,timer:$}=this.messageManager.get(f);return clearTimeout($),R(N),this.messageManager.delete(f),!0}return!1}waitForTrace(f,N=20000,R){return new Promise(($,z)=>{const E=setTimeout(()=>{if(this.messageManager.has(f))this.messageManager.delete(f),console.warn(`Timeout waiting for traceId: ${f}`),$({code:408,msg:"Device response timeout",traceId:f,error:"Timeout waiting for device response",requestData:R})},N);this.messageManager.set(f,{resolve:$,reject:z,timer:E,requestData:R})})}}class Z{f;rows=[];currentRow=null;constructor(f){this.name=f}text(f,N,R=0){if(!this.currentRow)this.currentRow={buttons:[]},this.rows.push(this.currentRow);return this.currentRow.buttons.push({title:f,value:N,type:R}),this}row(){if(!this.currentRow||this.currentRow.buttons.length===0)return this;return this.currentRow={buttons:[]},this.rows.push(this.currentRow),this}toJSON(){return{name:this.name,rows:this.rows.filter((f)=>f.buttons.length>0)}}}export{Z as InlineKeyBoard,Y as BotManager};
